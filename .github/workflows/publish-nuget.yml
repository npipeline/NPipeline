name: Publish NuGet (CI)

on:
  push:
    branches:
      - main

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  build-test-publish:
    name: Build, Test and Publish
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token generation (trusted publishing)
    
    environment:
      name: nuget-ci
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Needed for source link
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v5
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Generate CI version
      id: version
      run: |
        # Generate date in YYYYMMDD format
        DATE=$(date +%Y%m%d)
        # Use GitHub run number for build number
        BUILD_NUMBER=${{ github.run_number }}
        # Create pre-release version
        VERSION="1.0.0-ci.${DATE}.${BUILD_NUMBER}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release -p:Version=${{ steps.version.outputs.version }}
      
    - name: Run tests
      run: dotnet test --no-build --configuration Release --verbosity normal
      
    - name: Pack NuGet packages
      run: dotnet pack --no-build --configuration Release --output ./artifacts/packages -p:Version=${{ steps.version.outputs.version }}
      
    - name: Get NuGet API key via trusted publishing (OIDC)
      uses: NuGet/login@v1
      id: nuget_login
      with:
        user: npipeline
        
    - name: Publish packages to NuGet
      run: |
        find ./artifacts/packages -name "*.nupkg" -not -name "*.symbols.nupkg" | while read pkg; do
          echo "Publishing: $pkg"
          dotnet nuget push "$pkg" \
            --api-key ${{ steps.nuget_login.outputs.token }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \
            --no-symbols
        done